{% extends 'main/base.html' %}
{% load static %}
{% block content %}
<div class="orders-container">
    <div class="orders-header">
        <h2>Orders Management</h2>
        <div class="order-filters">
            <div class="filter-group">
                <label for="timeFilter">Time Period:</label>
                <select id="timeFilter">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="custom">Custom Date</option>
                </select>
            </div>
            <div class="filter-group" id="customDateFilter" style="display: none;">
                <label for="datePicker">Select Date:</label>
                <input type="date" id="datePicker">
            </div>
            <div class="filter-group">
                <label for="userFilter">User:</label>
                <select id="userFilter">
                    <option value="all">All Users</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Status:</label>
                <select id="statusFilter">
                    <option value="all">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="success">Completed</option>
                    <option value="wish_list">Wish List</option>
                </select>
            </div>
            <button id="applyFilter" class="filter-btn">Apply Filters</button>
        </div>
    </div>

    <div class="order-analytics">
        <div class="card">
            <h3>Total Orders</h3>
            <div class="value" id="totalOrders">0</div>
            <div class="progress">
                <div class="progress-bar" style="width: 100%"></div>
            </div>
        </div>
        <div class="card">
            <h3>Total Sales</h3>
            <div class="value" id="totalSales">₵0.00</div>
            <div class="progress">
                <div class="progress-bar" style="width: 100%"></div>
            </div>
        </div>
        <div class="card">
            <h3>Pending Orders</h3>
            <div class="value" id="pendingOrders">0</div>
            <div class="progress">
                <div class="progress-bar" style="width: 100%"></div>
            </div>
        </div>
    </div>

    <div class="orders-table">
        <table>
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Date</th>
                    <th>User</th>
                    <th>Items</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">
            </tbody>
        </table>
    </div>
</div>

<script>
const isAdmin = {% if request.user.is_admin %}true{% else %}false{% endif %};

document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadOrders('today', 'all', 'all');
    
    document.getElementById('timeFilter').addEventListener('change', function() {
        document.getElementById('customDateFilter').style.display = 
            this.value === 'custom' ? 'flex' : 'none';
    });
    
    document.getElementById('applyFilter').addEventListener('click', applyFilters);
});

async function loadUsers() {
    try {
        const response = await fetch('/orders/get-users/');
        const data = await response.json();
        populateUserFilter(data.users);
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

function populateUserFilter(users) {
    const userFilter = document.getElementById('userFilter');
    userFilter.innerHTML = '<option value="all">All Users</option>';
    
    if (users && users.length > 0) {
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.username;
            userFilter.appendChild(option);
        });
    }
}

function applyFilters() {
    const timeFilter = document.getElementById('timeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const userFilter = document.getElementById('userFilter').value;
    let dateFilter = '';
    
    if (timeFilter === 'custom') {
        dateFilter = document.getElementById('datePicker').value;
        if (!dateFilter) {
            alert('Please select a date');
            return;
        }
    }
    
    loadOrders(timeFilter, statusFilter, userFilter, dateFilter);
}

async function loadOrders(timeFilter, statusFilter, userFilter, customDate = '') {
    try {
        const params = new URLSearchParams();
        params.append('time_filter', timeFilter);
        params.append('status_filter', statusFilter);
        params.append('user_filter', userFilter);
        if (customDate) params.append('custom_date', customDate);
        
        const response = await fetch(`/orders/filter/?${params.toString()}`);
        const data = await response.json();
        updateAnalytics(data);
        renderOrdersTable(data);
    } catch (error) {
        console.error('Error loading orders:', error);
        alert('Failed to load orders. Please try again.');
    }
}

function updateAnalytics(data) {
    document.getElementById('totalOrders').textContent = data.total_orders || 0;
    document.getElementById('totalSales').textContent = `₵${parseFloat(data.total_sales || 0).toFixed(2)}`;
    document.getElementById('pendingOrders').textContent = data.pending_orders || 0;
}

function renderOrdersTable(data) {
    const tableBody = document.getElementById('ordersTableBody');
    tableBody.innerHTML = '';
    
    if (!data.orders || data.orders.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7" class="no-orders">No orders found</td></tr>`;
        return;
    }
    
    data.orders.forEach(order => {
        const row = document.createElement('tr');
        row.innerHTML = generateOrderRowHTML(order);
        tableBody.appendChild(row);
    });
}

function generateOrderRowHTML(order) {
    const statusClass = getStatusClass(order.status);
    
    return `
        <td>${order.order_id || 'N/A'}</td>
        <td>${formatDate(order.created_at) || 'N/A'}</td>
        <td>${order.user_username || 'Guest'}</td>
        <td>${order.item_count || 0}</td>
        <td>₵${parseFloat(order.total_price || 0).toFixed(2)}</td>
        <td><span class="status ${statusClass}">${order.status_display || 'N/A'}</span></td>
        <td>
            <div class="action-buttons">
                <a href="#" class="view-btn" onclick="viewOrderDetails(${order.id || 0})">
                    <i class="fas fa-eye"></i> View
                </a>
                ${isAdmin ? `
                <a href="##" class="delete-btn" onclick="confirmDeleteOrder(${order.id || 0})">
                    <i class="fas fa-trash"></i> Delete
                </a>
                ` : ''}
            </div>
        </td>
    `;
}

function getStatusClass(status) {
    switch(status) {
        case 'success': return 'completed';
        case 'pending': return 'pending';
        case 'wish_list': return 'wishlist';
        default: return '';
    }
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

async function viewOrderDetails(orderId) {
    window.location.href = `/order/details/${orderId}`;
}

async function confirmDeleteOrder(orderId) {
    if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) return;
    
    try {
        const response = await fetch(`/orders/${orderId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Order deleted successfully');
            applyFilters();
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    } catch (error) {
        console.error('Error deleting order:', error);
        alert(`Failed to delete order: ${error.message}`);
    }
}
</script>

<style>
.orders-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.orders-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.order-filters {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-group label {
    font-weight: 500;
    white-space: nowrap;
}

.filter-group select, .filter-group input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    min-width: 150px;
}

.filter-btn {
    padding: 8px 16px;
    background: var(--secondary);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
}

.filter-btn:hover {
    background: var(--secondary-dark);
}

.order-analytics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.card h3 {
    margin-top: 0;
    color: #555;
    font-size: 1rem;
}

.card .value {
    font-size: 1.8rem;
    font-weight: 600;
    margin: 10px 0;
}

.progress {
    height: 4px;
    background: #f0f0f0;
    border-radius: 2px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: var(--primary);
}

.orders-table {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    overflow-x: auto;
}

.orders-table table {
    width: 100%;
    border-collapse: collapse;
    min-width: 900px;
}

.orders-table th, .orders-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.orders-table th {
    background: var(--bg);
    font-weight: 600;
    color: #555;
}

.orders-table tr:hover {
    background-color: #f9f9f9;
}

.status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
    display: inline-block;
    min-width: 80px;
    text-align: center;
}

.status.completed {
    background: rgba(2, 138, 15, 0.1);
    color: var(--success);
}

.status.pending {
    background: rgba(255, 165, 0, 0.1);
    color: orange;
}

.status.wishlist {
    background: rgba(108, 92, 231, 0.1);
    color: var(--primary);
}

.action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.action-buttons a {
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
}

.view-btn {
    background: #f0f0f0;
    color: #333;
    transition: all 0.3s;
}

.view-btn:hover {
    background: #e0e0e0;
}

.delete-btn {
    background: #f5f5f5;
    color: #666;
    transition: all 0.3s;
}

.delete-btn:hover {
    background: #e5e5e5;
}

.no-orders {
    text-align: center;
    padding: 20px;
    color: #666;
}

@media (max-width: 768px) {
    .orders-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .order-filters {
        width: 100%;
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-group {
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
    }
    
    .filter-group select, .filter-group input {
        width: 100%;
    }
    
    .filter-btn {
        width: 100%;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 5px;
    }
    
    .action-buttons a {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock content %}