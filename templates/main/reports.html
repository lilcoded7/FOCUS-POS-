{% extends 'main/base.html' %}
{% load static %}
{% block content %}
<div class="reports-container">
    <div class="reports-header">
        <h2>Reports Management</h2>
        <div class="header-actions">
            <div class="report-filters">
                <div class="filter-group">
                    <label for="timeFilter">Time Period:</label>
                    <select id="timeFilter">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom Date</option>
                    </select>
                </div>
                <div class="filter-group" id="customDateFilter" style="display: none;">
                    <label for="datePicker">Select Date:</label>
                    <input type="date" id="datePicker">
                </div>
                <div class="filter-group">
                    <label for="typeFilter">Report Type:</label>
                    <select id="typeFilter">
                        <option value="all">All Types</option>
                        <option value="order_cancel">Order Cancellations</option>
                        <option value="system">System Reports</option>
                        <option value="other">Other Reports</option>
                    </select>
                </div>
                <button id="applyFilter" class="filter-btn">Apply Filters</button>
            </div>
            <button id="exportPdf" class="export-btn">
                <i class="fas fa-file-pdf"></i> Export as PDF
            </button>
        </div>
    </div>

    <div class="reports-table">
        <table>
            <thead>
                <tr>
                    <th>Report ID</th>
                    <th>User</th>
                    <th>Date</th>
                    <th>Context</th>
                    <th>Description</th>
                    <th>Related Order</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="reportsTableBody">
                {% for report in reports %}
                <tr>
                    <td>{{ report.id }}</td>
                    <td>{% if report.user.username %}{{ report.user.username }}{% else %}N/A{% endif %}</td>
                    <td>{{ report.created_at|date:"Y-m-d H:i" }}</td>
                    <td>{{ report.context }}</td>
                    <td>{{ report.dec|default:"-" }}</td>
                    <td>
                        {% if report.order %}
                            <a href="#" onclick="viewOrderDetails('{{ report.order.id }}')">
                                #{{ report.order.order_id }}
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="#" class="view-btn" onclick="viewReportDetails('{{ report.id }}')">
                                <i class="fas fa-eye"></i> View
                            </a>
                            {% if request.user.is_admin %}
                            <a href="#" class="delete-btn" onclick="confirmDeleteReport('{{ report.id }}')">
                                <i class="fas fa-trash"></i> Delete
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Report Details Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Report Details</h3>
                <button class="modal-close" onclick="closeModal('reportModal')">&times;</button>
            </div>
            <div id="reportDetailsContent">
                <!-- Report details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
// Initialize jsPDF
window.jsPDF = window.jspdf.jsPDF;

document.addEventListener('DOMContentLoaded', function() {
    // Setup event listeners
    document.getElementById('timeFilter').addEventListener('change', function() {
        if (this.value === 'custom') {
            document.getElementById('customDateFilter').style.display = 'flex';
        } else {
            document.getElementById('customDateFilter').style.display = 'none';
        }
    });
    
    document.getElementById('applyFilter').addEventListener('click', function() {
        const timeFilter = document.getElementById('timeFilter').value;
        const typeFilter = document.getElementById('typeFilter').value;
        let dateFilter = '';
        
        if (timeFilter === 'custom') {
            dateFilter = document.getElementById('datePicker').value;
            if (!dateFilter) {
                alert('Please select a date');
                return;
            }
        }
        
        loadReports(timeFilter, typeFilter, dateFilter);
    });
    
    // Add event listener for PDF export button
    document.getElementById('exportPdf').addEventListener('click', exportToPdf);
});

function loadReports(timeFilter, typeFilter, customDate = '') {
    const params = new URLSearchParams();
    params.append('time_filter', timeFilter);
    params.append('type_filter', typeFilter);
    if (customDate) params.append('custom_date', customDate);
    
    fetch(`/reports/filter/?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            // Update reports table
            const tableBody = document.getElementById('reportsTableBody');
            tableBody.innerHTML = '';
            
            data.reports.forEach(report => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${report.id}</td>
                    <td>${report.created_at}</td>
                    <td>${report.context}</td>
                    <td>${report.dec || '-'}</td>
                    <td>
                        ${report.order_id ? 
                            `<a href="#" onclick="viewOrderDetails(${report.order_id})">#${report.order_number}</a>` : 
                            '-'}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="#" class="view-btn" onclick="viewReportDetails(${report.id})">
                                <i class="fas fa-eye"></i> View
                            </a>
                            <a href="#" class="delete-btn" onclick="confirmDeleteReport(${report.id})">
                                <i class="fas fa-trash"></i> Delete
                            </a>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error loading reports:', error);
            alert('Failed to load reports. Please try again.');
        });
}

function viewReportDetails(reportId) {
    fetch(`/reports/${reportId}/detail/`)
        .then(response => response.json())
        .then(data => {
            const content = `
                <div class="report-detail">
                    <div class="detail-row">
                        <strong>Report ID:</strong> ${data.id}
                    </div>
                    <div class="detail-row">
                        <strong>Created At:</strong> ${data.created_at}
                    </div>
                    <div class="detail-row">
                        <strong>Context:</strong> ${data.context}
                    </div>
                    <div class="detail-row">
                        <strong>Description:</strong> ${data.dec || 'No description'}
                    </div>
                    ${data.order_id ? `
                    <div class="detail-row">
                        <strong>Related Order:</strong> 
                        <a href="#" onclick="viewOrderDetails(${data.order_id})">#${data.order_number}</a>
                    </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('reportDetailsContent').innerHTML = content;
            document.getElementById('reportModal').style.display = 'flex';
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('reportDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    Failed to load report details. Please try again.
                </div>
            `;
            document.getElementById('reportModal').style.display = 'flex';
        });
}

function confirmDeleteReport(reportId) {
    if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
        fetch(`/reports/${reportId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Report deleted successfully');
                // Refresh reports
                const timeFilter = document.getElementById('timeFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                loadReports(timeFilter, typeFilter);
            } else {
                alert('Failed to delete report: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete report. Please try again.');
        });
    }
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function viewOrderDetails(orderId) {
    // Implement order details view
    alert('Order details for ID: ' + orderId);
    // You can reuse the order details modal from your orders page
}

function exportToPdf() {
    // Get current filter values
    const timeFilter = document.getElementById('timeFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    let dateFilter = '';
    
    if (timeFilter === 'custom') {
        dateFilter = document.getElementById('datePicker').value;
        if (!dateFilter) {
            alert('Please select a date for custom filter');
            return;
        }
    }
    
    // Create PDF document
    const doc = new jsPDF();
    
    // Add title
    doc.setFontSize(18);
    doc.text('Reports Export', 14, 22);
    
    // Add filter information
    doc.setFontSize(12);
    let filterText = `Time Period: ${document.getElementById('timeFilter').options[document.getElementById('timeFilter').selectedIndex].text}`;
    if (timeFilter === 'custom') {
        filterText += ` (${dateFilter})`;
    }
    filterText += ` | Report Type: ${document.getElementById('typeFilter').options[document.getElementById('typeFilter').selectedIndex].text}`;
    doc.text(filterText, 14, 30);
    
    // Add export date
    doc.text(`Exported on: ${new Date().toLocaleString()}`, 14, 38);
    
    // Prepare table data
    const tableRows = [];
    const table = document.getElementById('reportsTableBody');
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const cols = rows[i].getElementsByTagName('td');
        const rowData = [];
        
        for (let j = 0; j < cols.length; j++) {
            // Skip the actions column (last column)
            if (j === cols.length - 1) continue;
            
            // For order links, extract just the text
            if (j === 5 && cols[j].querySelector('a')) {
                rowData.push(cols[j].querySelector('a').textContent);
            } else {
                rowData.push(cols[j].textContent.trim());
            }
        }
        
        tableRows.push(rowData);
    }
    
    // Add table to PDF
    doc.autoTable({
        head: [['Report ID', 'User', 'Date', 'Context', 'Description', 'Related Order']],
        body: tableRows,
        startY: 45,
        styles: { fontSize: 10 },
        headStyles: { fillColor: [66, 135, 245] }
    });
    
    // Save the PDF
    const fileName = `reports_export_${new Date().toISOString().slice(0, 10)}.pdf`;
    doc.save(fileName);
}
</script>

<style>
.reports-container {
    padding: 20px;
}

.reports-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.header-actions {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
}

.report-filters {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-group label {
    font-weight: 500;
    white-space: nowrap;
}

.filter-group select, .filter-group input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    min-width: 150px;
}

.filter-btn, .export-btn {
    padding: 8px 16px;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-btn {
    background: var(--secondary);
}

.export-btn {
    background: #e74c3c;
    align-self: flex-start;
}

.reports-table {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    overflow-x: auto;
}

.reports-table table {
    width: 100%;
    border-collapse: collapse;
}

.reports-table th, .reports-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.reports-table th {
    background: var(--bg);
    font-weight: 600;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.action-buttons a {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    text-decoration: none;
}

.view-btn {
    background: #f0f0f0;
    color: #333;
}

.delete-btn {
    background: #fff0f0;
    color: #d32f2f;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
}

.report-detail .detail-row {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.report-detail .detail-row:last-child {
    border-bottom: none;
}

@media (max-width: 768px) {
    .reports-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .report-filters {
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
    }
    
    .filter-group {
        width: 100%;
    }
    
    .filter-group select, .filter-group input {
        width: 100%;
    }
    
    .filter-btn, .export-btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock content %}